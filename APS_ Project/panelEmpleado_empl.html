<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Empleado</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* Modal centrado */
    dialog#dlgEmpleado[open]{
      position:fixed; inset:50% auto auto 50%;
      transform:translate(-50%,-50%); margin:0;
      border:0; border-radius:12px; padding:1rem 1.25rem;
      width:min(92vw,520px);
      background:var(--panel-bg,#fff);
      color:inherit;
    }
    dialog#dlgEmpleado::backdrop{ background:rgba(0,0,0,.45); }
    .form-grid{ display:grid; gap:.75rem; grid-template-columns:1fr 1fr; }
    .form-grid .full{ grid-column:1 / -1; }
    .field label{ display:block; font-size:.9rem; margin:0 0 .25rem; opacity:.9; }
    .field input{ width:100%; padding:.55rem .65rem; border-radius:.5rem;
      border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.08); color:inherit;}
    .field input::placeholder{opacity:.7}
    .modal-actions{ display:flex; gap:.5rem; justify-content:flex-end; margin-top:.75rem; }
    .btn{ padding:.6rem 1rem; border-radius:.7rem; border:1px solid transparent; cursor:pointer; }
    .btn-primary{ background:#3b82f6; color:#fff; }
    .btn-secondary{ background:#2b2f3a; color:#fff; }
    .btn-small{ padding:.35rem .65rem; font-size:.9rem; border-radius:.5rem; }
    .btn-danger{ background:#b91c1c; color:#fff; }
    .error-text{ color:#ff6b6b; font-size:.9rem; margin:.25rem 0 0; min-height:1.2em; }
  </style>
</head>
<body class="panel-empleado">
<header class="site-header">
  <div class="container">
    <h1 class="site-title">Seguros Grupo Amarillo</h1>
    <p class="site-subtitle">Panel Administrador - Empleados</p>
  </div>
  <nav class="main-nav" aria-label="Panel Empleado">
    <ul class="menu">
      <li><a href="panelEmpleado.html" class="nav-cta">Seguros</a></li>
      <li><a href="panelEmpleado_empl.html" aria-current="page">Empleados</a></li>
      <li><a href="login.html" class="nav-cta">Salir</a></li>
    </ul>
  </nav>
</header>

<main class="main-content">
  <div class="admin-container">
    <div class="panel-visualizacion" id="panel-empleados">
      <h2>Empleados</h2>

      <div class="tabla-container">
        <table id="empleadosTable" class="data-table">
          <thead>
          <tr>
            <th>ID</th>
            <th>Nombre completo</th>
            <th>DNI</th>
            <th>Sector</th>
            <th>Rol/Cargo</th>
            <th>Teléfono</th>
            <th>Email</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="cta-group" style="margin-top:.75rem;display:flex;gap:.5rem;">
        <button id="btnEmpRefresh" class="btn btn-secondary">Refrescar</button>
        <button id="btnEmpAdd" class="btn btn-primary">Añadir</button>
      </div>
    </div>
  </div>
</main>

<!-- Modal crear/editar -->
<dialog id="dlgEmpleado">
  <form id="formEmpleado" method="dialog">
    <input type="hidden" id="empId" name="id">
    <h3 style="margin-top:0">Nuevo empleado</h3>
    <div class="form-grid">
      <div class="field">
        <label for="empNombre">Nombre *</label>
        <input id="empNombre" name="Nombre" required placeholder="p. ej. Juan" />
      </div>
      <div class="field">
        <label for="empApellido">Apellido *</label>
        <input id="empApellido" name="Apellido" required placeholder="p. ej. Perez" />
      </div>
      <div class="field">
        <label for="empDni">DNI *</label>
        <input id="empDni" name="DNI" required placeholder="p. ej. 34.343.123" inputmode="numeric" />
      </div>
      <div class="field">
        <label for="empTel">Teléfono</label>
        <input id="empTel" name="Telefono" placeholder="+54 9 11 2345 6789" inputmode="tel" />
      </div>
      <div class="field">
        <label for="empSector">Sector</label>
        <input id="empSector" name="Sector" placeholder="p. ej. Ventas" />
      </div>
      <div class="field">
        <label for="empRol">Rol / Cargo</label>
        <input id="empRol" name="Rol" placeholder="p. ej. Analista" />
      </div>
      <div class="field full">
        <label for="empEmail">Email</label>
        <input id="empEmail" name="Email" type="email" placeholder="nombre@empresa.com" />
      </div>
      <div class="full error-text" id="empError"></div>
    </div>
    <div class="modal-actions">
      <button type="button" id="btnCancelar" class="btn btn-secondary">Cancelar</button>
      <button type="submit" id="btnGuardar" class="btn btn-primary">Guardar</button>
    </div>
  </form>
</dialog>

<footer class="site-footer">
  <div class="container">
    <p>&copy; 2025 Seguros Grupo Amarillo. Todos los derechos reservados.</p>
  </div>
</footer>

<!-- Supabase + módulo empleados -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="empleados.js"></script>

<!-- UI -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const tbody = document.querySelector('#empleadosTable tbody');
  const btnRefresh = document.getElementById('btnEmpRefresh');
  const btnAdd = document.getElementById('btnEmpAdd');
  const dlg = document.getElementById('dlgEmpleado');
  const form = document.getElementById('formEmpleado');
  const err = document.getElementById('empError');
  const btnCancelar = document.getElementById('btnCancelar');
  const btnGuardar = document.getElementById('btnGuardar');
  const hidId = document.getElementById('empId');

  async function cargarTabla() {
    try {
      tbody.innerHTML = '<tr><td colspan="9">Cargando...</td></tr>';
      const empleados = await empleadosAPI.fetchEmpleados();
      if (!empleados?.length) {
        tbody.innerHTML = '<tr><td colspan="9">No hay empleados.</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      empleados.forEach(e => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.id}</td>
          <td>${empleadosAPI.nombreCompleto(e)}</td>
          <td>${e.DNI ?? ''}</td>
          <td>${empleadosAPI.leerSector(e)}</td>
          <td>${empleadosAPI.leerCargo(e)}</td>
          <td>${e.Telefono ?? ''}</td>
          <td>${e.Email ?? ''}</td>
          <td>${e.Estado ?? 'activo'}</td>
          <td>
            <button class="btn btn-small" data-id="${e.id}" data-action="edit">Editar</button>
            <button class="btn btn-small btn-danger" data-id="${e.id}" data-action="delete">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (ex) {
      console.error(ex);
      tbody.innerHTML = '<tr><td colspan="9">Error cargando empleados: ' + (ex.message || JSON.stringify(ex)) + '</td></tr>';
    }
  }

  // Delegación: editar / eliminar
  tbody.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button'); if (!btn) return;
    const id = Number(btn.dataset.id); const action = btn.dataset.action;

    if (action === 'edit') {
      try {
        const emp = await empleadosAPI.fetchEmpleadoById(id);
        if (!emp) throw new Error('Empleado no encontrado');
        form.reset(); err.textContent = ''; hidId.value = emp.id;
        form.Nombre.value   = emp.Nombre   ?? '';
        form.Apellido.value = emp.Apellido ?? '';
        form.DNI.value      = emp.DNI      ?? '';
        form.Telefono.value = emp.Telefono ?? '';
        if (form.Sector) form.Sector.value = emp.Sector ?? '';
        if (form.Rol)    form.Rol.value    = emp.Rol    ?? '';
        if (form.Email)  form.Email.value  = emp.Email  ?? '';
        dlg.showModal();
      } catch (e) {
        alert('Error cargando empleado: ' + (e.message || JSON.stringify(e)));
      }
    }

    if (action === 'delete') {
      if (!confirm('¿Eliminar empleado #' + id + '?')) return;
      try {
        await empleadosAPI.deleteEmpleado(id);
        await cargarTabla();
        alert('Empleado eliminado.');
      } catch (e) {
        console.error(e);
        alert('Error eliminando: ' + (e.message || JSON.stringify(e)));
      }
    }
  });

  // Guardar (crear o actualizar)
  async function submitEmpleado(ev){
    ev.preventDefault(); err.textContent = ''; btnGuardar.disabled = true;
    const idEdit = Number(hidId.value || 0);

    const raw = {
      Nombre:   form.Nombre.value.trim(),
      Apellido: form.Apellido.value.trim(),
      DNI:      form.DNI.value.trim(),
      Telefono: (form.Telefono?.value || '').trim(),
      Sector:   (form.Sector?.value || '').trim(),
      Rol:      (form.Rol?.value || '').trim(),
      Email:    (form.Email?.value || '').trim(),
    };
    if (!raw.Nombre || !raw.Apellido || !raw.DNI){
      err.textContent = 'Completá Nombre, Apellido y DNI.'; btnGuardar.disabled = false; return;
    }
    const payload = Object.fromEntries(Object.entries(raw).filter(([_,v]) => v !== ''));

    try{
      if (idEdit) await empleadosAPI.updateEmpleado(idEdit, payload);
      else        await empleadosAPI.createEmpleado(payload);
      form.reset(); hidId.value=''; dlg.close(); await cargarTabla();
    }catch(e){
      console.error(e); err.textContent = e.message || 'Error guardando empleado.';
    }finally{ btnGuardar.disabled = false; }
  }

  // Botones
  btnRefresh.addEventListener('click', cargarTabla);
  btnAdd.addEventListener('click', ()=>{ form.reset(); hidId.value=''; err.textContent=''; dlg.showModal(); });
  btnCancelar.addEventListener('click', ()=> dlg.close());
  form.addEventListener('submit', submitEmpleado);

  cargarTabla();
});
</script>
</body>
</html>
