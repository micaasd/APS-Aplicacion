<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Contrata tu seguro de manera fácil y segura. Ofrecemos diversos tipos de pólizas adaptadas a tus necesidades.">
    <title>Panel Empleado</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="panel-empleado">
    <header class="site-header">
        <div class="container">
            <h1 class="site-title">Seguros Grupo Amarillo</h1>
            <p class="site-subtitle">Panel Administrador - Seguros</p>
        </div>
        
        <nav class="main-nav" aria-label="Panel Empleado">
            <ul class="menu">
                <li><a href="panelEmpleado.html" aria-current="page">Seguros</a></li>
                <li><a href="panelEmpleado_empl.html" class="nav-cta">Empleados</a></li>
                <li><a href="login.html" class="nav-cta">Salir</a></li>
            </ul>
        </nav>
    </header>

    <main class="main-content">
        <div class="admin-container">
            <div class="columna-paneles"> 
                <div class="panel-visualizacion">
                    <h2>Seguros Activos</h2>
                    <div class="tabla-container">
                        <table id="segurosTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>DNI Asegurado</th>
                                    <th>Nro Póliza</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

            <div class="panel-solicitudes">
                        <h2>Solicitudes Pendientes</h2>
                        <div class="tabla-container">
                            <table id="solicitudesTable" class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>DNI Asegurado</th>
                                        <th>Nro Póliza</th>
                                        <th>Fecha Fin</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="solicitudesBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>

             </div><div class="panel-acciones">
                <h2>Acciones</h2>
                    <div class="cta-group">
                        <button id="btnRefresh" class="btn btn-secondary">Refrescar</button>
                        <button id="btnAddSeguro" class="btn btn-primary">Agregar Seguro</button>
                        <button id="btnUpdateAll" class="btn btn-secondary">Actualizar Seguros</button>
                        <button id="btnSelectDelete" class="btn btn-danger">Eliminar Seguro</button>
                        <button id="btnSelectModify" class="btn btn-secondary">Modificar Seguro</button>
                    </div>
            </div>

        </div>
    </main>


    <footer class="site-footer">
        <div class="container">
            <p>&copy; 2025 Seguros Grupo Amarillo. Todos los derechos reservados.</p>
        </div>
    </footer>
    
    <div id="seguroModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle">Agregar Seguro</h3>
            <form id="formSeguro">
                <input type="hidden" id="idSeguro">
                <label for="asegurado">DNI Asegurado:</label>
                <input type="number" id="asegurado" required>
                <label for="nroPoliza">Nro Póliza:</label>
                <input type="number" id="nroPoliza">
                <label for="fechaFin">Fecha Fin (opcional):</label>
                <input type="datetime-local" id="fechaFin">
                
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" id="cancelBtn" class="btn">Cancelar</button>
                </div>
            </form>
            <div id="modalMsg" class="modal-msg"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="seguros.js"></script>
    <script>
    // UI wiring for panelEmpleado
    const segurosTableBody = document.querySelector('#segurosTable tbody');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnAddSeguro = document.getElementById('btnAddSeguro');
    const seguroModal = document.getElementById('seguroModal');
    const formSeguro = document.getElementById('formSeguro');
    const cancelBtn = document.getElementById('cancelBtn');
    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');

    async function loadSeguros() {
        try {
            segurosTableBody.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
            const data = await window.segurosAPI.fetchSeguros();
            if (!data || data.length === 0) {
                segurosTableBody.innerHTML = '<tr><td colspan="6">No hay seguros.</td></tr>';
                return;
            }
            segurosTableBody.innerHTML = '';
            data.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.idSeguro}</td>
                    <td>${s.asegurado}</td>
                    <td>${s.nroPoliza ?? ''}</td>
                    <td>${new Date(s.fechaInicio).toLocaleString()}</td>
                    <td>${s.fechaFin ? new Date(s.fechaFin).toLocaleString() : ''}</td>
                    <td>
                        <button class="btn btn-small" data-id="${s.idSeguro}" data-action="edit">Editar</button>
                        <button class="btn btn-small btn-danger" data-id="${s.idSeguro}" data-action="delete">Eliminar</button>
                    </td>
                `;
                segurosTableBody.appendChild(tr);
            });
        } catch (err) {
            segurosTableBody.innerHTML = `<tr><td colspan="6">Error cargando seguros: ${err.message}</td></tr>`;
        }
    }

    btnRefresh.addEventListener('click', loadSeguros);

    btnAddSeguro.addEventListener('click', () => {
        formSeguro.reset();
        modalTitle.textContent = 'Agregar Seguro';
        document.getElementById('idSeguro').value = '';
        seguroModal.style.display = 'flex'; // Usar flex para centrar
    });

    cancelBtn.addEventListener('click', () => {
        seguroModal.style.display = 'none';
        modalMsg.textContent = '';
        modalMsg.style.color = ''; // Resetear color
    });

    segurosTableBody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if (action === 'edit') {
           
            try {
                const seguros = await window.segurosAPI.fetchSeguros();
                const s = seguros.find(x => String(x.idSeguro) === String(id));
                if (!s) throw new Error('Seguro no encontrado');
                document.getElementById('idSeguro').value = s.idSeguro;
                document.getElementById('asegurado').value = s.asegurado;
                document.getElementById('nroPoliza').value = s.nroPoliza ?? '';
                document.getElementById('fechaFin').value = s.fechaFin ? new Date(s.fechaFin).toISOString().slice(0,16) : '';
                modalTitle.textContent = 'Editar Seguro ' + s.idSeguro;
                seguroModal.style.display = 'flex'; // Usar flex
            } catch (err) {
                alert('Error: ' + err.message);
            }
        } else if (action === 'delete') {
            if (!confirm('¿Confirma eliminar este seguro?')) return;
            try {
                const numericId = parseInt(id, 10);
                console.debug('[UI] inline delete id', numericId);
                const res = await window.segurosAPI.deleteSeguro(numericId);
                console.debug('[UI] inline delete result', res);
                await loadSeguros();
                alert('Seguro eliminado');
            } catch (err) {
                console.error('Error eliminando:', err);
                const details = err && err.message ? err.message : JSON.stringify(err);
                modalMsg.textContent = 'Error eliminando: ' + details;
                alert('Error eliminando: ' + details);
            }
        }
    });

    formSeguro.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('idSeguro').value;
        const asegurado = parseInt(document.getElementById('asegurado').value, 10);
        const nroPoliza = document.getElementById('nroPoliza').value ? parseInt(document.getElementById('nroPoliza').value,10) : null;
        const fechaFinVal = document.getElementById('fechaFin').value;
        const fechaFin = fechaFinVal ? new Date(fechaFinVal).toISOString() : null;
        
        modalMsg.textContent = 'Guardando...';
        modalMsg.style.color = ''; // Resetear color

        try {
            if (id) {
                const res = await window.segurosAPI.updateSeguro(parseInt(id,10), { asegurado, nroPoliza, fechaFin });
                console.debug('[UI] updateSeguro response', res);
                modalMsg.textContent = 'Actualizado correctamente';
            } else {
                const res = await window.segurosAPI.createSeguro({ asegurado, nroPoliza, fechaFin });
                console.debug('[UI] createSeguro response', res);
                modalMsg.textContent = 'Creado correctamente';
            }
            modalMsg.style.color = 'green';

            setTimeout(async () => {
                seguroModal.style.display = 'none';
                modalMsg.textContent = '';
                modalMsg.style.color = '';
                await loadSeguros();
            }, 900);
        } catch (err) {
            modalMsg.textContent = 'Error: ' + err.message;
            modalMsg.style.color = 'crimson';
        }
    });

    
    //loadSeguros();
    
    // --- HTML para el modal de selección (AHORA CON CLASES CSS) ---
    const selectModalHtml = `
        <div class="modal-content">
            <h3 id="selectModalTitle">Seleccionar Seguro</h3>
            <form id="selectForm">
                <label for="selectSeguro">Seguro:</label>
                <select id="selectSeguro"></select>
            </form>
            <div id="selectModalMsg" class="modal-msg"></div>
            <div class="modal-actions">
                <button type="button" id="selectCancelBtn" class="btn">Cancelar</button>
                <button type="button" id="selectConfirmBtn" class="btn btn-primary">Confirmar</button>
            </div>
        </div>`;

    
    const selectModalContainer = document.createElement('div');
    selectModalContainer.id = 'selectSeguroModal';
    // --- USA CLASE CSS EN LUGAR DE ESTILO EN LÍNEA ---
    selectModalContainer.className = 'modal-overlay';
    selectModalContainer.innerHTML = selectModalHtml;
    document.body.appendChild(selectModalContainer);

    const btnSelectDelete = document.getElementById('btnSelectDelete');
    const btnSelectModify = document.getElementById('btnSelectModify');
    const btnUpdateAll = document.getElementById('btnUpdateAll');

    async function populateSelectSeguro() {
        const sel = document.getElementById('selectSeguro');
        sel.innerHTML = '<option value="">Cargando...</option>';
        try {
            const seguros = await window.segurosAPI.fetchSeguros();
            if (!seguros || seguros.length === 0) {
                sel.innerHTML = '<option value="">No hay seguros</option>';
                return [];
            }
            sel.innerHTML = '';
            seguros.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.idSeguro;
                opt.textContent = `${s.idSeguro} — DNI:${s.asegurado} — Pol:${s.nroPoliza ?? ''}`;
                sel.appendChild(opt);
            });
            return seguros;
        } catch (err) {
            sel.innerHTML = `<option value="">Error: ${err.message}</option>`;
            return [];
        }
    }

    
    function openSelectModal(mode) {
        const container = document.getElementById('selectSeguroModal');
        const title = document.getElementById('selectModalTitle');
        const confirmBtn = document.getElementById('selectConfirmBtn');
        const cancelBtn = document.getElementById('selectCancelBtn');
        const msg = document.getElementById('selectModalMsg');
        
        title.textContent = mode === 'delete' ? 'Eliminar Seguro' : 'Modificar Seguro';
        confirmBtn.textContent = mode === 'delete' ? 'Eliminar' : 'Modificar';
        
        // --- APLICA EL ESTILO DANGER AL BOTÓN ---
        if (mode === 'delete') {
            confirmBtn.classList.add('btn-danger');
            confirmBtn.classList.remove('btn-primary');
        } else {
            confirmBtn.classList.add('btn-primary');
            confirmBtn.classList.remove('btn-danger');
        }
        
        msg.textContent = '';
        msg.style.color = ''; // Resetear color
        populateSelectSeguro();
        container.style.display = 'flex'; // Usar flex

        cancelBtn.onclick = () => { container.style.display = 'none'; };
        confirmBtn.onclick = async () => {
            const sel = document.getElementById('selectSeguro');
            const id = sel.value;
            if (!id) { msg.textContent = 'Seleccione un seguro.'; msg.style.color = 'crimson'; return; }
            if (mode === 'delete') {
                if (!confirm('Confirma eliminar el seguro ' + id + '?')) return;
                try {
                    const numericId = parseInt(id,10);
                    console.debug('[UI] modal delete id', numericId);
                    const res = await window.segurosAPI.deleteSeguro(numericId);
                    console.debug('[UI] modal delete result', res);
                    msg.textContent = 'Eliminado correctamente.';
                    msg.style.color = 'green';
                    await loadSeguros();
                    setTimeout(() => { container.style.display = 'none'; }, 700);
                } catch (err) { 
                    console.error(err); 
                    msg.textContent = 'Error: ' + (err.message || JSON.stringify(err));
                    msg.style.color = 'crimson';
                }
            } else {
                // load seleccion into edit modal
                try {
                    const seguros = await window.segurosAPI.fetchSeguros();
                    const s = seguros.find(x => String(x.idSeguro) === String(id));
                    if (!s) throw new Error('Seguro no encontrado');
                    document.getElementById('idSeguro').value = s.idSeguro;
                    document.getElementById('asegurado').value = s.asegurado;
                    document.getElementById('nroPoliza').value = s.nroPoliza ?? '';
                    document.getElementById('fechaFin').value = s.fechaFin ? new Date(s.fechaFin).toISOString().slice(0,16) : '';
                    modalTitle.textContent = 'Editar Seguro ' + s.idSeguro;
                    container.style.display = 'none';
                    seguroModal.style.display = 'flex'; // Usar flex
                } catch (err) { msg.textContent = 'Error: ' + err.message; msg.style.color = 'crimson';}
            }
        };
    }

    btnSelectDelete.addEventListener('click', () => openSelectModal('delete'));
    btnSelectModify.addEventListener('click', () => openSelectModal('modify'));
    btnUpdateAll.addEventListener('click', async () => { await loadSeguros(); alert('Actualizado'); });

    //Manejo de solicitudes - ACTUALIZADO
    const solicitudesBody = document.getElementById('solicitudesBody');

    async function loadSolicitudes() {
        try {
            // Estado de carga en la tabla
            solicitudesBody.innerHTML = '<tr><td colspan="5">Cargando solicitudes...</td></tr>';
            
            const solicitudes = await window.segurosAPI.fetchSolicitudes();
            
            if (!solicitudes || solicitudes.length === 0) {
                // Mensaje de "no hay" en la tabla
                solicitudesBody.innerHTML = '<tr><td colspan="5">No hay solicitudes pendientes.</td></tr>';
                return;
            }

            solicitudesBody.innerHTML = ''; // Limpiar "Cargando..."
            
            solicitudes.forEach(s => {
                const tr = document.createElement('tr');

                // Crear el botón de acción
                const btn = document.createElement('button');
                btn.className = 'btn btn-small btn-primary'; // Estilo consistente
                btn.textContent = 'Activar';
                btn.onclick = async () => {
                    try {
                        // create real seguro
                        await window.segurosAPI.createSeguro({ asegurado: s.asegurado, nroPoliza: s.nroPoliza, fechaFin: s.fechaFin });
                        // delete solicitud
                        await window.segurosAPI.deleteSolicitud(s.id);
                        await loadSeguros();
                        await loadSolicitudes();
                        alert('Solicitud activada: póliza agregada.');
                    } catch (err) {
                        console.error('Error activando solicitud', err);
                        alert('Error activando: ' + (err.message || JSON.stringify(err)));
                    }
                };
                
                // Llenar la fila con datos
                tr.innerHTML = `
                    <td>${s.id}</td>
                    <td>${s.asegurado}</td>
                    <td>${s.nroPoliza ?? ''}</td>
                    <td>${s.fechaFin ? new Date(s.fechaFin).toLocaleString() : ''}</td>
                    <td></td> 
                `;
                
                // Añadir el botón a la última celda
                tr.cells[4].appendChild(btn);
                
                solicitudesBody.appendChild(tr);
            });
            
        } catch (err) {
            // Mensaje de error en la tabla
            solicitudesBody.innerHTML = '<tr><td colspan="5">Error cargando solicitudes: ' + (err.message || JSON.stringify(err)) + '</td></tr>';
        }
    }

    // Cargas iniciales
    loadSeguros();
    loadSolicitudes();
    </script>
</body>
</html>