<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Página de Pago (Tarjeta)</title>
    <style>
      :root {
        --bg: #f4f6f8;
        --card: #fff;
        --accent: #0b76ef;
        --muted: #6b7280;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      }
      body { margin: 0; background: var(--bg); color: #111; }
      .wrap { max-width: 880px; margin: 48px auto; padding: 24px; }
      header { margin-bottom: 18px; }
      h1 { margin: 0 0 6px; font-size: 20px; }
      p.lead { margin: 0; color: var(--muted); font-size: 14px; }
      .card {
        background: var(--card);
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
        padding: 20px; margin-top: 18px;
      }
      form { display: grid; gap: 12px; }
      label { font-size: 13px; color: var(--muted); }
      input, select, button {
        font: inherit; padding: 10px 12px; border-radius: 8px;
        border: 1px solid #e6e9ee; background: #fff;
      }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .muted { font-size: 13px; color: var(--muted); }
      button { background: var(--accent); color: #fff; border: none; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: default; }
      .success { padding: 12px; border-radius: 8px; background: #e6ffef; color: #065f3b; display: none; }
      footer { margin-top: 18px; font-size: 13px; color: var(--muted); }
      @media (max-width: 560px) { .row { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Pagar pedido</h1>
        <p class="lead">Complete los datos a continuación para procesar el pago.</p>
      </header>

      <section class="card" aria-labelledby="form-title">
        <h2 id="form-title" class="muted" style="margin-top: 0">Detalles de pago</h2>

        <form id="paymentForm" autocomplete="on" novalidate>
          <div class="row">
            <div>
              <label for="fullName">Nombre completo</label>
              <input id="fullName" name="fullName" type="text" placeholder="Nombre Apellido" required />
            </div>
            <div>
              <label for="email">Correo electrónico</label>
              <input id="email" name="email" type="email" placeholder="ejemplo@dominio.com" required />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="amount">Importe</label>
              <input id="amount" name="amount" type="number" min="0.01" step="0.01" placeholder="0.00" required />
            </div>
            <div>
              <label for="currency">Moneda</label>
              <select id="currency" name="currency">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="ARS" selected>Peso Argentino</option>
              </select>
            </div>
          </div>

          <div>
            <label for="card">Número de tarjeta</label>
            <input id="card" name="card" type="text" inputmode="numeric" placeholder="0000 0000 0000 0000" pattern="[0-9\s]{13,19}" required />
          </div>

          <div class="row">
            <div>
              <label for="expiry">Fecha Vencimiento (MM/AA)</label>
              <input id="expiry" name="expiry" type="text" placeholder="MM/AA" pattern="^(0[1-9]|1[0-2])\/?([0-9]{2})$" required />
            </div>
            <div>
              <label for="cvc">CVC</label>
              <input id="cvc" name="cvc" type="text" inputmode="numeric" pattern="[0-9]{3,4}" placeholder="123" required />
            </div>
          </div>

          <div style="display: flex; gap: 10px; align-items: center">
            <button id="payBtn" type="submit">Pagar</button>
            <div id="loading" class="muted" aria-hidden="true" style="display: none">Procesando…</div>
          </div>

          <div id="success" class="success" role="status">
            Pago realizado con éxito. Tu comprobante se descargará en unos segundos.
          </div>
        </form>
      </section>

      <footer>
        <p>Este es un ejemplo de plantilla HTML. No procese datos reales en entornos no seguros.</p>
      </footer>
    </div>

    <!-- jsPDF para generar PDF en el navegador -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
    <!-- Supabase (opcional) para actualizar el Pago como 'pagado' -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      const params = new URLSearchParams(location.search);
      const pagoIdQS = params.get("pagoId");
      const seguroIdQS = params.get("seguroId");
      let pagoActual = null;
      try { pagoActual = JSON.parse(sessionStorage.getItem("pagoActual") || "null"); } catch (_) { pagoActual = null; }

      const form = document.getElementById("paymentForm");
      const payBtn = document.getElementById("payBtn");
      const loading = document.getElementById("loading");
      const success = document.getElementById("success");

      // Si ya creaste el cliente Supabase en otra página, exponelo como window._SUPABASE_CLIENT
      let _SUPABASE = null;
      if (window._SUPABASE_CLIENT && window._SUPABASE_CLIENT.from) {
        _SUPABASE = window._SUPABASE_CLIENT;
      } else if (window.supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY && window.supabase.createClient) {
        _SUPABASE = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      }

      function fechaISOdia(d = new Date()) { return d.toISOString().slice(0, 10); }

      async function actualizarPagoSupabase({ idPago, importe }) {
        if (!_SUPABASE || !idPago) return;
        try {
          const { error } = await _SUPABASE
            .from("Pago")
            .update({
              estado: "pagado",
              metodoPago: "Tarjeta",
              costo: Math.round(Number(importe) || 0),
              fechaPago: fechaISOdia(new Date())
            })
            .eq("idPago", Number(idPago));
          if (error) console.warn("No se pudo actualizar Pago:", error);
        } catch (e) {
          console.warn("Excepción actualizando Pago:", e);
        }
      }

      async function generarYDescargarPDF(datos) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const cx = 105;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("Comprobante de Pago", cx, 16, { align: "center" });

        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        const y0 = 30; let y = y0; const dx = 12;

        const pares = [
          ["Fecha", datos.fecha],
          ["Pago ID", datos.pagoId || "-"],
          ["Seguro ID", datos.seguroId || "-"],
          ["Método", "Tarjeta"],
          ["Importe", `${datos.importe} ${datos.moneda}`],
          ["Nombre", datos.nombre],
          ["Email", datos.email],
        ];
        pares.forEach(([k, v]) => {
          doc.text(`${k}:`, dx, y);
          doc.text(String(v || "-"), 60, y);
          y += 8;
        });

        doc.setDrawColor(200);
        doc.line(dx, y0 - 8, 200 - dx, y0 - 8);

        const nombreArchivo = `comprobante_pago_${datos.pagoId || "tarjeta"}_${datos.fecha.replaceAll("-", "")}.pdf`;
        doc.save(nombreArchivo);
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!form.checkValidity()) { form.reportValidity(); return; }

        payBtn.disabled = true;
        loading.style.display = "inline";
        success.style.display = "none";

        const nombre = document.getElementById("fullName").value.trim();
        const email = document.getElementById("email").value.trim();
        const importe = document.getElementById("amount").value.trim();
        const moneda = document.getElementById("currency").value;

        const pagoId = pagoIdQS || (pagoActual && pagoActual.idPago) || null;
        const seguroId = seguroIdQS || (pagoActual && pagoActual.idSeguro) || null;

        setTimeout(async () => {
          loading.style.display = "none";
          payBtn.disabled = false;
          success.style.display = "block";

          await actualizarPagoSupabase({ idPago: pagoId, importe });

          await generarYDescargarPDF({
            fecha: fechaISOdia(new Date()),
            pagoId, seguroId, importe, moneda, nombre, email,
          });

          form.reset();
        }, 1000);
      });
    </script>
  </body>
</html>
